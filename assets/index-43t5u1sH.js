(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const r of o.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&s(r)}).observe(document,{childList:!0,subtree:!0});function e(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerPolicy&&(o.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?o.credentials="include":i.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(i){if(i.ep)return;i.ep=!0;const o=e(i);fetch(i.href,o)}})();const m=["red","blue","green","yellow","purple","orange"],a=8,u=8,h=60,w=u*h,p=a*h,M=300,y={red:"triangle",blue:"polygon",green:"polygon",yellow:"square",purple:"circle",orange:"circle"},G={red:"#e74c3c",blue:"#3498db",green:"#2ecc71",yellow:"#f1c40f",purple:"#9b59b6",orange:"#e67e22"},x="#2c4359",A="#95a5a6",I="circle";var f=(l=>(l[l.IDLE=0]="IDLE",l[l.ANIMATING=1]="ANIMATING",l))(f||{});class g{constructor(t,e,s){this.row=t,this.col=e,this.color=s,this.x=this.col*this.size,this.y=this.row*this.size}x;y;isMatch=!1;isSelected=!1;size=h;speed=M;get isMoving(){const t=this.col*this.size,e=this.row*this.size;return Math.abs(this.x-t)>1||Math.abs(this.y-e)>1}update(t){const e=this.row*this.size,s=this.col*this.size;return Math.abs(this.y-e)>1?this.y<e?(this.y+=this.speed*t,this.y>e&&(this.y=e)):(this.y-=this.speed*t,this.y<e&&(this.y=e)):this.y=e,Math.abs(this.x-s)>1?this.x<s?(this.x+=this.speed*t,this.x>s&&(this.x=s)):(this.x-=this.speed*t,this.x<s&&(this.x=s)):this.x=s,this.isMoving}}class v{cells;constructor(){this.cells=[],this.initializeGrid()}initializeGrid(){this.cells=[];for(let t=0;t<a;t++){const e=[];for(let s=0;s<u;s++){const i=this.getRandomTypeNoMatch(t,s,e);e.push(new g(t,s,i))}this.cells.push(e)}}getGem(t,e){return this.isValidPosition(t,e)?this.cells[t][e]:null}getAllGems(){return this.cells.flat()}swapGems(t,e){this.cells[t.row][t.col]=e,this.cells[e.row][e.col]=t;const s=t.row,i=t.col;t.row=e.row,t.col=e.col,e.row=s,e.col=i}getRandomTypeNoMatch(t,e,s){let i,o;do{o=!1;const r=Math.floor(Math.random()*m.length);if(i=m[r],e>=2){const c=s[e-1],n=s[e-2];c.color===i&&n.color===i&&(o=!0)}if(t>=2){const c=this.cells[t-1][e],n=this.cells[t-2][e];c.color===i&&n.color===i&&(o=!0)}}while(o);return i}findMatches(){let t=!1;this.getAllGems().forEach(e=>e.isMatch=!1);for(let e=0;e<a;e++)for(let s=0;s<u-2;s++){const i=this.cells[e][s],o=this.cells[e][s+1],r=this.cells[e][s+2];i.color===o.color&&i.color===r.color&&(i.isMatch=!0,o.isMatch=!0,r.isMatch=!0,t=!0)}for(let e=0;e<u;e++)for(let s=0;s<a-2;s++){const i=this.cells[s][e],o=this.cells[s+1][e],r=this.cells[s+2][e];i.color===o.color&&i.color===r.color&&(i.isMatch=!0,o.isMatch=!0,r.isMatch=!0,t=!0)}return t}getRandomSimpleColor(){const t=Math.floor(Math.random()*m.length);return m[t]}applyGravity(){for(let t=0;t<u;t++){const e=[];for(let i=0;i<a;i++){const o=this.cells[i][t];o.isMatch||e.push(o)}const s=a-e.length;if(s>0){const i=[];for(let r=0;r<s;r++){const c=this.getRandomSimpleColor(),n=new g(0,t,c);n.y=-h*(s-r),i.push(n)}const o=[...i,...e];for(let r=0;r<a;r++){const c=o[r];c.row=r,c.col=t,c.isMatch=!1,this.cells[r][t]=c}}}}update(t){this.getAllGems().forEach(e=>e.update(t))}isValidPosition(t,e){return t>=0&&t<a&&e>=0&&e<u}isAnimating(){return this.getAllGems().some(t=>t.isMoving)}}class E{constructor(t){this.ctx=t,this.radius=h/2-5}centerX=0;centerY=0;radius;getFigureName(t){return y[t]||I}getFillColor(t){return G[t]||A}drawCircle(){this.ctx.arc(this.centerX,this.centerY,this.radius,0,Math.PI*2)}drawSquare(){const t=this.radius*1.7,e=t/2;this.ctx.rect(this.centerX-e,this.centerY-e,t,t)}drawTriangle(){const t=this.radius*1.1,e=this.radius*.26;this.ctx.moveTo(this.centerX,this.centerY-t+e),this.ctx.lineTo(this.centerX+t*.866,this.centerY+t*.5+e),this.ctx.lineTo(this.centerX-t*.866,this.centerY+t*.5+e)}drawPolygon(){const e=Math.PI*2/6,s=-Math.PI/2;this.ctx.moveTo(this.centerX+this.radius*Math.cos(s),this.centerY+this.radius*Math.sin(s));for(let i=1;i<6;i++){const o=s+e*i;this.ctx.lineTo(this.centerX+this.radius*Math.cos(o),this.centerY+this.radius*Math.sin(o))}}draw(t){switch(this.centerX=t.x+h/2,this.centerY=t.y+h/2,this.ctx.beginPath(),this.getFigureName(t.color)){case"square":this.drawSquare();break;case"polygon":this.drawPolygon();break;case"triangle":this.drawTriangle();break;default:this.drawCircle();break}t.isMatch?this.ctx.fillStyle="#898787":this.ctx.fillStyle=this.getFillColor(t.color),this.ctx.fill(),t.isSelected?(this.ctx.lineWidth=4,this.ctx.strokeStyle="#ffffff",this.ctx.stroke()):(this.ctx.lineWidth=1,this.ctx.strokeStyle="rgba(0,0,0,0.2)",this.ctx.stroke()),this.ctx.closePath()}}class C{canvas;ctx;grid;lastTime=0;selectedGem=null;state=f.IDLE;gemRenderer;constructor(t){const e=document.getElementById(t);if(!e)throw new Error(`Canvas with id "${t}" not found`);this.canvas=e;const s=this.canvas.getContext("2d");if(!s)throw new Error("Could not get 2D context");this.ctx=s,this.gemRenderer=new E(this.ctx),this.canvas.width=w,this.canvas.height=p,this.grid=new v,this.loop=this.loop.bind(this),this.handleInput=this.handleInput.bind(this),this.canvas.addEventListener("mousedown",this.handleInput),requestAnimationFrame(this.loop)}async handleInput(t){if(this.state!==f.IDLE)return;const e=this.canvas.getBoundingClientRect(),s=this.canvas.width/e.width,i=this.canvas.height/e.height,o=(t.clientX-e.left)*s,r=(t.clientY-e.top)*i,c=Math.floor(o/h),n=Math.floor(r/h);console.log(`Click at Col: ${c}, Row: ${n}`);const d=this.grid.getGem(n,c);d&&(this.selectedGem===null?this.selectGem(d):this.selectedGem===d?this.deselectGem():this.isNeighbor(this.selectedGem,d)?await this.handleSwapInteraction(this.selectedGem,d):(this.deselectGem(),this.selectGem(d)))}async handleSwapInteraction(t,e){this.state=f.ANIMATING,this.grid.swapGems(t,e),await this.waitForAnimations(),this.grid.findMatches()?(this.deselectGem(),await this.processCascade()):(this.grid.swapGems(t,e),await this.waitForAnimations(),this.deselectGem()),this.state=f.IDLE}async processCascade(){let t=!0;for(;t;)await this.delay(200),this.grid.applyGravity(),await this.waitForAnimations(),t=this.grid.findMatches()}async waitForAnimations(){return new Promise(t=>{const e=()=>{this.grid.isAnimating()?requestAnimationFrame(e):t()};e()})}delay(t){return new Promise(e=>setTimeout(e,t))}selectGem(t){this.selectedGem=t,t.isSelected=!0,console.log(`Selected gem at ${t.row},${t.col}`)}deselectGem(){this.selectedGem&&(this.selectedGem.isSelected=!1,this.selectedGem=null)}isNeighbor(t,e){const s=Math.abs(t.row-e.row),i=Math.abs(t.col-e.col);return s===1&&i===0||s===0&&i===1}loop(t){if(this.lastTime===0){this.lastTime=t,requestAnimationFrame(this.loop);return}const e=t-this.lastTime;this.lastTime=t,this.update(e),this.render(),requestAnimationFrame(this.loop)}update(t){this.grid.update(t/1e3)}render(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.fillStyle=x,this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.grid.getAllGems().forEach(e=>{this.gemRenderer.draw(e)})}}window.addEventListener("load",()=>{new C("game-canvas")});
