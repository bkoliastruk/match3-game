(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const o of s)if(o.type==="childList")for(const r of o.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&i(r)}).observe(document,{childList:!0,subtree:!0});function e(s){const o={};return s.integrity&&(o.integrity=s.integrity),s.referrerPolicy&&(o.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?o.credentials="include":s.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function i(s){if(s.ep)return;s.ep=!0;const o=e(s);fetch(s.href,o)}})();const f=["red","blue","green","yellow","purple","orange"],n=8,d=8,h=60,g=d*h,w=n*h,p={red:"triangle",blue:"polygon",green:"polygon",yellow:"square",purple:"circle",orange:"circle"},G={red:"#e74c3c",blue:"#3498db",green:"#2ecc71",yellow:"#f1c40f",purple:"#9b59b6",orange:"#e67e22"},M="#2c4359",y="#95a5a6",x="circle";class m{constructor(t,e,i){this.row=t,this.col=e,this.color=i,this.x=this.col*this.size,this.y=this.row*this.size}x;y;isMatch=!1;isSelected=!1;size=h;update(t){const e=this.col*this.size,i=this.row*this.size,s=e-this.x,o=i-this.y;Math.abs(s)>1?this.x+=s*10*t:this.x=e,Math.abs(o)>1?this.y+=o*10*t:this.y=i}snapToGrid(){this.x=this.col*this.size,this.y=this.row*this.size}}class R{cells;constructor(){this.cells=[],this.initializeGrid()}initializeGrid(){this.cells=[];for(let t=0;t<n;t++){const e=[];for(let i=0;i<d;i++){const s=this.getRandomTypeNoMatch(t,i,e);e.push(new m(t,i,s))}this.cells.push(e)}}getGem(t,e){return this.isValidPosition(t,e)?this.cells[t][e]:null}getAllGems(){return this.cells.flat()}swapGems(t,e){this.cells[t.row][t.col]=e,this.cells[e.row][e.col]=t;const i=t.row,s=t.col;t.row=e.row,t.col=e.col,e.row=i,e.col=s}getRandomTypeNoMatch(t,e,i){let s,o;do{o=!1;const r=Math.floor(Math.random()*f.length);if(s=f[r],e>=2){const c=i[e-1],l=i[e-2];c.color===s&&l.color===s&&(o=!0)}if(t>=2){const c=this.cells[t-1][e],l=this.cells[t-2][e];c.color===s&&l.color===s&&(o=!0)}}while(o);return s}findMatches(){let t=!1;this.getAllGems().forEach(e=>e.isMatch=!1);for(let e=0;e<n;e++)for(let i=0;i<d-2;i++){const s=this.cells[e][i],o=this.cells[e][i+1],r=this.cells[e][i+2];s.color===o.color&&s.color===r.color&&(s.isMatch=!0,o.isMatch=!0,r.isMatch=!0,t=!0)}for(let e=0;e<d;e++)for(let i=0;i<n-2;i++){const s=this.cells[i][e],o=this.cells[i+1][e],r=this.cells[i+2][e];s.color===o.color&&s.color===r.color&&(s.isMatch=!0,o.isMatch=!0,r.isMatch=!0,t=!0)}return t}getRandomSimpleColor(){const t=Math.floor(Math.random()*f.length);return f[t]}applyGravity(){for(let t=0;t<d;t++){let e=[];for(let c=0;c<n;c++)e.push(this.cells[c][t]);const i=e.filter(c=>!c.isMatch),s=n-i.length,o=[];for(let c=0;c<s;c++){const l=this.getRandomSimpleColor();o.push(new m(0,t,l))}const r=[...o,...i];for(let c=0;c<n;c++){const l=r[c];l.row=c,l.col=t,l.isMatch=!1,l.snapToGrid(),this.cells[c][t]=l}}}update(t){this.getAllGems().forEach(e=>e.update(t))}isValidPosition(t,e){return t>=0&&t<n&&e>=0&&e<d}}class v{constructor(t){this.ctx=t,this.radius=h/2-5}centerX=0;centerY=0;radius;getFigureName(t){return p[t]||x}getFillColor(t){return G[t]||y}drawCircle(){this.ctx.arc(this.centerX,this.centerY,this.radius,0,Math.PI*2)}drawSquare(){const t=this.radius*1.7,e=t/2;this.ctx.rect(this.centerX-e,this.centerY-e,t,t)}drawTriangle(){const t=this.radius*1.1,e=this.radius*.26;this.ctx.moveTo(this.centerX,this.centerY-t+e),this.ctx.lineTo(this.centerX+t*.866,this.centerY+t*.5+e),this.ctx.lineTo(this.centerX-t*.866,this.centerY+t*.5+e)}drawPolygon(){const e=Math.PI*2/6,i=-Math.PI/2;this.ctx.moveTo(this.centerX+this.radius*Math.cos(i),this.centerY+this.radius*Math.sin(i));for(let s=1;s<6;s++){const o=i+e*s;this.ctx.lineTo(this.centerX+this.radius*Math.cos(o),this.centerY+this.radius*Math.sin(o))}}draw(t){switch(this.centerX=t.x+h/2,this.centerY=t.y+h/2,this.ctx.beginPath(),this.getFigureName(t.color)){case"square":this.drawSquare();break;case"polygon":this.drawPolygon();break;case"triangle":this.drawTriangle();break;default:this.drawCircle();break}t.isMatch?this.ctx.fillStyle="#898787":this.ctx.fillStyle=this.getFillColor(t.color),this.ctx.fill(),t.isSelected?(this.ctx.lineWidth=4,this.ctx.strokeStyle="#ffffff",this.ctx.stroke()):(this.ctx.lineWidth=1,this.ctx.strokeStyle="rgba(0,0,0,0.2)",this.ctx.stroke()),this.ctx.closePath()}}class P{canvas;ctx;grid;lastTime=0;selectedGem=null;isProcessing=!1;gemRenderer;constructor(t){const e=document.getElementById(t);if(!e)throw new Error(`Canvas with id "${t}" not found`);this.canvas=e;const i=this.canvas.getContext("2d");if(!i)throw new Error("Could not get 2D context");this.ctx=i,this.gemRenderer=new v(this.ctx),this.canvas.width=g,this.canvas.height=w,this.grid=new R,this.loop=this.loop.bind(this),this.handleInput=this.handleInput.bind(this),this.canvas.addEventListener("mousedown",this.handleInput),requestAnimationFrame(this.loop)}async handleInput(t){if(this.isProcessing)return;const e=this.canvas.getBoundingClientRect(),i=this.canvas.width/e.width,s=this.canvas.height/e.height,o=(t.clientX-e.left)*i,r=(t.clientY-e.top)*s,c=Math.floor(o/h),l=Math.floor(r/h);console.log(`Click at Col: ${c}, Row: ${l}`);const a=this.grid.getGem(l,c);a&&(this.selectedGem===null?this.selectGem(a):this.selectedGem===a?this.deselectGem():this.isNeighbor(this.selectedGem,a)?this.swapGems(this.selectedGem,a):(this.deselectGem(),this.selectGem(a)))}selectGem(t){this.selectedGem=t,t.isSelected=!0,console.log(`Selected gem at ${t.row},${t.col}`)}deselectGem(){this.selectedGem&&(this.selectedGem.isSelected=!1,this.selectedGem=null)}isNeighbor(t,e){const i=Math.abs(t.row-e.row),s=Math.abs(t.col-e.col);return i===1&&s===0||i===0&&s===1}async handleMatches(){for(;this.grid.findMatches();)await new Promise(t=>setTimeout(t,250)),this.grid.applyGravity(),await new Promise(t=>setTimeout(t,400));console.log("Grid is clean. Cascade finished.")}async swapGems(t,e){if(this.isProcessing)return;this.isProcessing=!0,this.grid.swapGems(t,e),await new Promise(s=>setTimeout(s,300)),this.grid.findMatches()?(console.log("Match found! Starting cascade..."),this.deselectGem(),await this.handleMatches()):(console.log("No match. Reverting swap."),this.grid.swapGems(t,e),await new Promise(s=>setTimeout(s,300)),this.deselectGem()),this.isProcessing=!1}loop(t){const e=t-this.lastTime;this.lastTime=t,this.update(e),this.render(),requestAnimationFrame(this.loop)}update(t){this.grid.update(t/1e3)}render(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.fillStyle=M,this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.grid.getAllGems().forEach(e=>{this.gemRenderer.draw(e)})}}window.addEventListener("load",()=>{new P("game-canvas")});
